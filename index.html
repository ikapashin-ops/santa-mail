<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ—á—Ç–∞ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Roboto',sans-serif;background:#135D46;min-height:100vh;overflow-x:hidden;display:flex;align-items:center;justify-content:center;padding:50px 20px}
        body::before,body::after{content:'';position:fixed;left:0;right:0;height:25px;background:repeating-linear-gradient(45deg,#499F87 0,#499F87 40px,transparent 40px,transparent 56px,#FF5252 56px,#FF5252 96px,transparent 96px,transparent 112px);z-index:9999;pointer-events:none}
        body::before{top:0}
        body::after{bottom:0}
        .snow{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:2;overflow:hidden}
        .flake{position:absolute;top:-50px;opacity:0;animation:fall linear infinite}
        @keyframes fall{0%{transform:translateY(-50px);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(calc(100vh + 50px));opacity:0}}
        .wrap{max-width:700px;width:100%;position:relative;z-index:10}
        .santa{position:absolute;top:-30px;right:-30px;font-size:80px;transform:scaleX(-1);animation:wave 3s ease-in-out infinite;z-index:5}
        @keyframes wave{0%,100%{transform:scaleX(-1) translateY(0)}50%{transform:scaleX(-1) translateY(-8px)}}
        .deadline{background:#499F87;color:#fff;padding:15px 30px;border-radius:12px;text-align:center;font-weight:bold;font-size:18px;margin-bottom:30px;box-shadow:0 0 20px rgba(73,159,135,0.3)}
        .form{background:#fef9f0;border:5px solid #FF5252;border-radius:30px;padding:40px;box-shadow:0 0 40px rgba(73,159,135,0.4),0 0 80px rgba(73,159,135,0.2)}
        h1{color:#FF5252;font-size:36px;font-weight:bold;text-align:center;margin-bottom:15px;margin-top:0}
        .sub{color:#135D46;font-size:16px;text-align:center;margin-bottom:30px}
        .group{margin-bottom:25px}
        label{display:block;margin-bottom:8px;font-size:16px;font-weight:bold;color:#135D46}
        input,textarea{width:100%;padding:15px;border:3px solid #499F87;border-radius:12px;font-size:16px;font-family:'Roboto',sans-serif}
        input:focus,textarea:focus{outline:none;border-color:#FF5252}
        textarea{min-height:180px;resize:vertical}
        button{background:#FF5252;color:#fff;padding:18px 40px;border:none;border-radius:16px;font-size:20px;font-weight:bold;cursor:pointer;width:100%;transition:all 0.3s}
        button:hover{background:#e63946;transform:translateY(-3px)}
        button:disabled{opacity:0.6;cursor:not-allowed}
        .msg{background:#499F87;color:#fff;padding:20px 30px;border-radius:12px;margin-top:25px;text-align:center;font-size:16px;font-weight:normal;display:none;border-left:5px solid #135D46;box-shadow:0 4px 15px rgba(73,159,135,0.3)}
        
        /* PDF Template */
        .pdf-template{width:800px;min-height:1100px;background:#135D46;position:relative;overflow:hidden;font-family:'Roboto',sans-serif;padding:0}
        .pdf-stripe{position:absolute;left:0;right:0;height:50px;background:repeating-linear-gradient(45deg,#499F87 0,#499F87 60px,transparent 60px,transparent 85px,#FF5252 56px,#FF5252 145px,transparent 145px,transparent 170px);z-index:1}
        .pdf-stripe-top{top:0}
        .pdf-stripe-bottom{bottom:0}
        .pdf-snowflake{position:absolute;color:rgba(255,255,255,0.15);font-size:30px;z-index:1}
        .pdf-content{position:relative;z-index:2;padding:120px 80px 80px;min-height:1100px}
        .pdf-title{color:#fff;font-size:48px;font-weight:bold;text-align:center;margin-bottom:60px;text-shadow:2px 2px 4px rgba(0,0,0,0.2)}
        .pdf-card{background:#fef9f0;border-radius:30px;padding:50px;box-shadow:0 8px 30px rgba(0,0,0,0.3)}
        .pdf-text{color:#135D46;font-size:20px;line-height:1.8;margin-bottom:40px;white-space:pre-wrap;word-wrap:break-word}
        .pdf-signature{color:#135D46;font-size:24px;font-weight:bold;text-align:right}
        
        @media(max-width:768px){body::before,body::after{height:40px}.wrap{margin:60px auto}.form{padding:30px 20px}h1{font-size:28px}}
    </style>
</head>
<body>
    <div class="snow" id="snow"></div>
    <audio id="music" loop>
        <source src="https://ikapashin-ops.github.io/santa-mail/compressed.mp3" type="audio/mpeg">
    </audio>
    <div class="wrap">
        <div class="deadline">‚è∞ –ü—Ä–∏—ë–º –ø–∏—Å–µ–º –¥–æ 24 –¥–µ–∫–∞–±—Ä—è –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ</div>
        <div class="form">
            <div class="santa">üéÖ</div>
            <h1>‚úâÔ∏è –ü–æ—á—Ç–∞ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞</h1>
            <p class="sub">–ù–∞–ø–∏—à–∏—Ç–µ —Ç—ë–ø–ª—ã–µ —Å–ª–æ–≤–∞ –∫–æ–ª–ª–µ–≥–∞–º –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ!</p>
            <form id="f">
                <div class="group">
                    <label for="n">–í–∞—à–µ –∏–º—è <span style="color:#FF5252">*</span></label>
                    <input type="text" id="n" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" required>
                </div>
                <div class="group">
                    <label for="r">–ö–æ–º—É –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–æ</label>
                    <input type="text" id="r" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ä–∏–∏ –ò–≤–∞–Ω–æ–≤–æ–π –∏–∑ –æ—Ç–¥–µ–ª–∞ –ø—Ä–æ–¥–∞–∂">
                </div>
                <div class="group">
                    <label for="m">–í–∞—à–µ –ø–∏—Å—å–º–æ <span style="color:#FF5252">*</span></label>
                    <textarea id="m" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å, –ø–æ–∂–µ–ª–∞–Ω–∏–µ –∏–ª–∏ —Ç—ë–ø–ª—ã–µ —Å–ª–æ–≤–∞..." required></textarea>
                </div>
                <button type="submit" id="submitBtn">ü¶å –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ</button>
            </form>
            <div class="msg" id="msg">‚ú® –ü–∏—Å—å–º–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ! üéÑ</div>
        </div>
    </div>

    <div id="pdfTemplate" style="position:fixed;left:-9999px;top:0;width:800px">
        <div class="pdf-template">
            <!-- –ü–æ–ª–æ—Å–∫–∏ –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
            <div class="pdf-stripe pdf-stripe-top"></div>
            <div class="pdf-stripe pdf-stripe-bottom"></div>
            
            <!-- –°–Ω–µ–∂–∏–Ω–∫–∏ -->
            <div class="pdf-snowflake" style="top:100px;left:50px">‚ùÑ</div>
            <div class="pdf-snowflake" style="top:200px;right:80px">‚ùÑ</div>
            <div class="pdf-snowflake" style="top:400px;left:100px">‚ùÑ</div>
            <div class="pdf-snowflake" style="top:600px;right:120px">‚ùÑ</div>
            <div class="pdf-snowflake" style="top:800px;left:150px">‚ùÑ</div>
            <div class="pdf-snowflake" style="top:300px;right:200px">‚ùÑ</div>
            
            <div class="pdf-content">
                <div class="pdf-title">–í–∞–º –ù–æ–≤–æ–≥–æ–¥–Ω–µ–µ –ü–∏—Å—å–º–æ!</div>
                <div class="pdf-card">
                    <div class="pdf-text" id="pdfMessage"></div>
                    <div class="pdf-signature" id="pdfSender"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = '8587638548:AAF11Jq3P-bWbZHI_2FonXGn08SpTZGPTuQ';
        const chat_id = '742126021';

        document.getElementById('f').onsubmit = async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...';
            
            const name = document.getElementById('n').value;
            const recipient = document.getElementById('r').value;
            const message = document.getElementById('m').value;
            
            try {
                // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const text = `üéÑ –ù–æ–≤–æ–µ –ø–∏—Å—å–º–æ –î–µ–¥—É –ú–æ—Ä–æ–∑—É!\n\nüë§ –û—Ç: ${name}\nüì® –ö–æ–º—É: ${recipient || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n\nüíå –ü–∏—Å—å–º–æ:\n${message}`;
                
                await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({chat_id, text})
                });
                
                // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
                submitBtn.textContent = 'üìÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF...';
                const pdfBlob = await generatePDF(name, message);
                
                // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF
                submitBtn.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF...';
                await sendToTelegram(pdfBlob, name);
                
                // –£—Å–ø–µ—Ö!
                document.getElementById('msg').style.display = 'block';
                e.target.reset();
                submitBtn.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                
                setTimeout(() => {
                    document.getElementById('msg').style.display = 'none';
                    submitBtn.textContent = 'ü¶å –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ';
                    submitBtn.disabled = false;
                }, 5000);
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + err.message);
                submitBtn.textContent = 'ü¶å –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ';
                submitBtn.disabled = false;
            }
        };

        async function generatePDF(sender, message) {
            return new Promise(async (resolve, reject) => {
                try {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —à–∞–±–ª–æ–Ω
                    document.getElementById('pdfMessage').textContent = message;
                    document.getElementById('pdfSender').textContent = `–û—Ç ${sender}`;
                    
                    const element = document.getElementById('pdfTemplate');
                    
                    // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
                    element.style.position = 'fixed';
                    element.style.left = '0';
                    element.style.top = '0';
                    element.style.zIndex = '-1';
                    element.style.opacity = '0';
                    element.style.pointerEvents = 'none';
                    
                    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤
                    await document.fonts.ready;
                    await new Promise(r => setTimeout(r, 200));
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º canvas
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#135D46',
                        width: 800,
                        height: 1100,
                        windowWidth: 800,
                        windowHeight: 1100
                    });
                    
                    // –ü—Ä—è—á–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                    element.style.left = '-9999px';
                    element.style.opacity = '1';
                    
                    // –°–æ–∑–¥–∞–µ–º PDF
                    const { jsPDF } = window.jspdf;
                    const imgWidth = 210; // A4 width in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    
                    const pdfBlob = pdf.output('blob');
                    resolve(pdfBlob);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function sendToTelegram(pdfBlob, sender) {
            const formData = new FormData();
            formData.append('chat_id', chat_id);
            formData.append('document', pdfBlob, `novogodnee_pismo_${sender.replace(/\s+/g, '_')}.pdf`);
            
            const response = await fetch(`https://api.telegram.org/bot${token}/sendDocument`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error('Telegram API error: ' + errorText);
            }
            
            return response.json();
        }
        
        // Music player
        const music = document.getElementById('music');
        let started = false;
        document.body.addEventListener('click', () => {
            if (!started) {
                music.play();
                started = true;
            }
        }, { once: true });
        
        // Snow animation
        const c = document.getElementById('snow');
        const s = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><g fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><line x1="25" y1="5" x2="25" y2="45"/><line x1="5" y1="25" x2="45" y2="25"/><line x1="12" y1="12" x2="38" y2="38"/><line x1="38" y1="12" x2="12" y2="38"/></g></svg>';
        
        function f() {
            const d = document.createElement('div');
            d.className = 'flake';
            const z = Math.random() * 12 + 4;
            const l = Math.random() * 100;
            const t = Math.random() * 8 + 12;
            d.innerHTML = s;
            d.style.cssText = `width:${z}px;height:${z}px;left:${l}%;opacity:${Math.random()*0.5+0.3};animation-duration:${t}s`;
            c.appendChild(d);
            setTimeout(() => d.remove(), t * 1000);
        }
        
        for (let i = 0; i < 180; i++) setTimeout(f, i * 40);
        setInterval(f, 80);
    </script>
</body>
</html>
